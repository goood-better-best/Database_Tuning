# 인덱스 튜닝

- 책에서는 랜덤 I/O를 줄이는 것을 강조함





## 3.1 테이블 엑세스 최소화

- 이번장에서는 테이블 랜덤 엑세스를 최소화하는 구체적인 방법들을 소개



### 3.1.1 테이블 랜덤 엑세스

- 인덱스로 검색하는데 느린 이유는 무엇일까?
  - 인덱스에 대한 이해도가 필요하다.



- 물리적 주소 vs 논리적 주소
  - 물리적 주소 : 실제 물리적 주소
  - 논리적 주소 : 논리적 의미를 담고 있음



- 인덱스 ROWID는 물리적 주소일까 논리적 주소일까?

  - 인덱스를 사용하는 이유는 ROWID를 빠르게 얻기 위함이다.

  - ROWID가 데이터파일 번호, 오브젝트 번호, 블록 번호 같은 물리적 요소로 이루어져 있기 때문에 물리적 주소라고 생각한다면 완전히 틀린 것은 아니다.

  - 하지만 ROWID는 논리적 주소에 가깝다.

    - 인덱스에서 ROWID를 찾자마자 바로 데이터를 찾아다주는 것이 아니다

    - ROWID를 확인 후 디스크에 접근하기 때문에 논리적 주소 정보라고 할 수 있다.

      

- 메인메모리 DB와 비교
  - 메인메모리 DB의 경우 메모리상의 주소정보를 인덱스로 갖는다.
  - 그 말은 인덱스를 경우해 테이블을 바로 융엑세스 할 수 있다는 의미다.
  - 오라클은 테이블 블록이 수시로 버퍼캐시에서 밀려났다가 다시 캐싱되기 때문에 인덱스에서 포인터로 직접 연결할 수 없는 구조다.
  - 메모리 주소 정보(포인터)가 아닌 디스크 주소 정보(Data Block Address)를 이용해 해시 알고리즘으로 버퍼 블록을 찾아감



- I/O 메커니즘 복습
  - DBA(=데이터파일번호 + 블록번호)는 디스크 상에서 블록을 찾기 위한 주소 정보
  - 매번 디스크에서 블록을 읽을 수 없으니 버퍼 캐시를 활용해야 함
  - 디스크 접근 전 DBA를 해시 함수에 넣은 다음 해시 체인을 찾고 버퍼 헤더를 찾는다.
  - 버퍼 헤더는 실제 데이터가 담긴 버퍼 블록의 주소값을 가지고 있다.

  



### 3.1.2 인덱스 클러스터링 팩터

- 클러스터링 팩터(Clustering Factor, CF)는 특정 컬럼을 기준으로 같은 값을 갖는 데이터가 서로 모여있는 정도를 의미함
  - 예를 들어 '거주지 = 제주'인 고객 데이터가 물리적으로 근접해 있는 것과 같다.
  - 인덱스 정렬순서와 물리적 접근도를 확인하면 된다.



- 인덱스 클러스팅 팩터 효과
  - 인덱스 ROWID로 테이블을 엑세스 할 때, 오라클은 래치 획득과 해시 체인 스캔과정을 거쳐 어렵게 찾아간 테이블 블록에 대한 포인터를 바로 해제하지 않고 일단 유지한다. 버퍼 Pinning이라 한다.
  - 이 상태에서 다음 인덱스 레코드를 읽는데 우연히 직전과 같은 테이블 블록을 가리키면 래치 획득과 해시 체인 스캔과정을 스킵하기 때문에 IO 효율이 좋아짐



### 3.1.3 인덱스 손익분기점

- 인덱스 ROWID를 이용한 테이블 엑세스는 고비용 구조이다.
  - 읽어야 할 데이터가 일정량을 넘는 순간 table full scan보다 느려진다.
  - 이 느려지는 시기가 손익분기점이다.

  

- Table Full Scan은 성능이 일정하다.
  - 반면 인덱스 스캔은 몇 건을 추출하느냐에 따라 성능이 천차만별로 달라진다.

  

- 인덱스를 이용한 테이블 엑세스가 Table Full Scan보다 느려지게 만드는 핵심적인 두 요소
  - Table Full Scan은 시퀀셜 엑세스인 반면, 인덱스 ROWID를 이용한 테이블 엑세스는 랜덤 엑세스 방식이다.
  - Table Full Scan은 Multiblock IO인 반면, 인덱스 ROWID를 이용한 테이블 엑세스는 Single Block IO이다.



